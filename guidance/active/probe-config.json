{
  "test_suite": "patch-validation",
  "probe_responses": [
    {
      "id": "patch1_nested_simple",
      "description": "Nested code blocks - simple case",
      "response": "I'll create a documentation file for you.\n\n```json:function\n{\n  \"name\": \"write_file\",\n  \"args\": {\n    \"filename\": \"api_guide.md\",\n    \"content\": \"# API Guide\\n\\nExample request:\\n\\n```json\\n{\\n  \\\"endpoint\\\": \\\"/api/users\\\",\\n  \\\"method\\\": \\\"POST\\\"\\n}\\n```\\n\\nThis should work!\"\n  }\n}\n```",
      "expected_logs": ["write_file", "api_guide.md"],
      "expected_errors": []
    },
    {
      "id": "patch1_nested_complex",
      "description": "Triple-nested markdown blocks",
      "response": "Creating a developer guide with multiple examples.\n\n```json:function\n{\n  \"name\": \"write_file\",\n  \"args\": {\n    \"filename\": \"delegation_schema.md\",\n    \"content\": \"# Delegation Schema\\n\\n## Format\\n\\n```json:delegation\\n{\\n  \\\"agent_id\\\": \\\"researcher\\\",\\n  \\\"task\\\": \\\"Find data\\\"\\n}\\n```\\n\\n## Tool Format\\n\\n```json:function\\n{\\n  \\\"name\\\": \\\"web_search\\\",\\n  \\\"args\\\": {\\\"query\\\": \\\"test\\\"}\\n}\\n```\"\n  }\n}\n```",
      "expected_logs": ["write_file", "delegation_schema.md"],
      "expected_errors": []
    },
    {
      "id": "patch2_reasoning_simple",
      "description": "Reasoning before tool call",
      "response": "I need to search for recent information about quantum computing advances. Let me query the web for the latest research papers.\n\n```json:function\n{\n  \"name\": \"web_search\",\n  \"args\": {\n    \"query\": \"quantum computing breakthroughs 2026\"\n  }\n}\n```",
      "expected_logs": ["REASONING", "web_search"],
      "expected_ui": ["Reasoning about next steps"]
    },
    {
      "id": "patch2_reasoning_multi",
      "description": "Multiple reasoning blocks with tools",
      "response": "First, I'll search for the company's financial data, then analyze it with Python.\n\n```json:function\n{\n  \"name\": \"web_search\",\n  \"args\": {\n    \"query\": \"Acme Corp Q4 2025 earnings\"\n  }\n}\n```\n\nNow I'll process the data to calculate growth metrics.\n\n```json:function\n{\n  \"name\": \"execute_python\",\n  \"args\": {\n    \"code\": \"revenue_growth = (450000 - 380000) / 380000 * 100\\nprint(f'Growth: {revenue_growth:.2f}%')\"\n  }\n}\n```",
      "expected_logs": ["REASONING", "web_search", "REASONING", "execute_python"],
      "expected_count": {"REASONING": 2}
    },
    {
      "id": "patch3_context_web",
      "description": "Context attachment with web search results",
      "response": "Based on my research, quantum computing has made significant progress in error correction.\n\n[AUTOMATED CONTEXT ATTACHMENT]\n--- web_search results ---\n{\n  \"result\": \"[{\\\"url\\\": \\\"https://nature.com/quantum-2026\\\", \\\"content\\\": \\\"Researchers at MIT demonstrated a 99.9% error correction rate using topological qubits, marking a breakthrough in quantum stability.\\\"}, {\\\"url\\\": \\\"https://science.org/quantum-advance\\\", \\\"content\\\": \\\"Google's Willow chip achieved quantum advantage in protein folding simulations, reducing computation time from weeks to hours.\\\"}]\"\n}",
      "expected_ui": ["AUTOMATED_CONTEXT", "2 SOURCES", "nature.com", "science.org"],
      "expected_components": ["ContextAttachmentCard"]
    },
    {
      "id": "patch3_context_multi",
      "description": "Multiple tool results in context",
      "response": "I've gathered the data and processed it.\n\n[AUTOMATED CONTEXT ATTACHMENT]\n--- web_search results ---\n{\n  \"result\": \"[{\\\"url\\\": \\\"https://data.gov/gdp\\\", \\\"content\\\": \\\"US GDP grew 2.8% in Q4 2025\\\"}]\"\n}\n--- read_file results ---\n{\n  \"result\": \"Sales Data:\\nQ1: $1.2M\\nQ2: $1.5M\\nQ3: $1.8M\\nQ4: $2.1M\"\n}",
      "expected_ui": ["2 SOURCES", "WEB_SEARCH DATA", "READ_FILE DATA"],
      "expected_sections": 2
    },
    {
      "id": "integration_full",
      "description": "All patches together - full integration",
      "response": "I need to create a comprehensive analysis. First, let me search for market data.\n\n```json:function\n{\n  \"name\": \"web_search\",\n  \"args\": {\n    \"query\": \"tech market trends 2026\"\n  }\n}\n```\n\nNow I'll document the findings in a structured format.\n\n```json:function\n{\n  \"name\": \"write_file\",\n  \"args\": {\n    \"filename\": \"market_analysis.md\",\n    \"content\": \"# Market Analysis\\n\\n## Data Sources\\n\\n```json\\n{\\n  \\\"primary\\\": \\\"Bloomberg\\\",\\n  \\\"secondary\\\": \\\"Reuters\\\"\\n}\\n```\\n\\n## Key Findings\\n- AI chips up 45%\\n- Cloud revenue stable\"\n  }\n}\n```\n\nBased on the data, the market shows strong growth in AI infrastructure.\n\n[AUTOMATED CONTEXT ATTACHMENT]\n--- web_search results ---\n{\n  \"result\": \"[{\\\"url\\\": \\\"https://bloomberg.com/tech-2026\\\", \\\"content\\\": \\\"AI semiconductor market reached $180B in 2025, projected 45% growth for 2026 driven by enterprise adoption.\\\"}]\"\n}",
      "expected_logs": ["REASONING", "web_search", "REASONING", "write_file"],
      "expected_ui": ["AUTOMATED_CONTEXT", "bloomberg.com"],
      "expected_errors": [],
      "critical": true
    }
  ],
  "validation_steps": [
    "1. Inject test response via probe",
    "2. Check backend logs for parse errors",
    "3. Verify frontend renders expected components",
    "4. Check browser console for JS errors",
    "5. Inspect UI for correct category labels"
  ],
  "automated_checks": {
    "backend": [
      "grep 'parse.*error' logs/agent-service.log",
      "grep 'Unbalanced braces' logs/agent-service.log",
      "redis-cli KEYS 'raro:e2b_files:*'"
    ],
    "frontend": [
      "Check for REASONING category in OutputPane",
      "Verify ContextAttachmentCard renders",
      "Confirm collapsible sections work"
    ]
  }
}

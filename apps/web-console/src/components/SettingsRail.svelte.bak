// [[RARO]]/apps/web-console/src/components/SettingsRail.svelte
// Purpose: "Hidden" Service Rail for System-Level Controls (Reality Shift).
// Architecture: Ancillary UI Component
// Dependencies: Stores

<script lang="ts">
  import { themeStore, toggleTheme } from '$lib/stores';
  
  let hovered = $state(false);
  let focused = $state(false); // A11y: Track focus within component

  let isOpen = $derived(hovered || focused);

  function handleFocus() { focused = true; }
  function handleBlur() { focused = false; }
</script>

<!-- 
  SERVICE RAIL
  - Expands on Hover OR Focus (Keyboard navigation).
  - Role 'complementary' defines it as a sidebar/aside area.
-->
<div 
  class="service-rail {isOpen ? 'expanded' : ''}"
  onmouseenter={() => hovered = true}
  onmouseleave={() => hovered = false}
  onfocusin={handleFocus}
  onfocusout={handleBlur}
  role="complementary"
  aria-label="System Configuration"
>
  <div class="rail-container">
    
    <!-- TOP: Identity / Decor -->
    <div class="rail-sector top">
      <div class="marker-vertical">SYS_CFG</div>
      <div class="screw-head"></div>
    </div>

    <!-- MIDDLE: The Control Unit -->
    <div class="rail-sector middle">
      
      <!-- Collapsed View: Just the Status LED -->
      <div class="status-compact" style="opacity: {isOpen ? 0 : 1}">
        <div class="status-dot {$themeStore === 'PHOSPHOR' ? 'active' : ''}"></div>
      </div>

      <!-- Expanded View: The Full Mechanism -->
      <div class="control-mechanism" style="opacity: {isOpen ? 1 : 0}">
        <div class="label-tiny">REALITY_SHIFT</div>
        
        <button 
          class="switch-track" 
          onclick={toggleTheme} 
          aria-label="Toggle Theme"
          aria-pressed={$themeStore === 'PHOSPHOR'}
        >
          <div class="switch-thumb {$themeStore === 'PHOSPHOR' ? 'down' : 'up'}">
            <div class="thumb-grip"></div>
          </div>
          <div class="track-marks">
            <span>A</span>
            <span>P</span>
          </div>
        </button>

        <div class="mode-readout">
          {$themeStore.slice(0, 3)}
        </div>
      </div>

    </div>

    <!-- BOTTOM: Versioning -->
    <div class="rail-sector bottom">
      <div class="screw-head"></div>
      <div class="marker-vertical">v0.9.4</div>
    </div>

  </div>
  
  <!-- Texture overlay for the rail itself -->
  <div class="rail-texture"></div>
</div>

<style>
  .service-rail {
    width: 48px;
    height: 100vh;
    border-right: 1px solid var(--paper-line);
    background: var(--paper-surface-dim); 
    display: flex;
    flex-direction: column;
    transition: width 0.4s var(--ease-snap), background-color 0.4s;
    overflow: hidden;
    position: relative;
    z-index: 50;
  }

  .service-rail.expanded {
    width: 80px;
    background: var(--paper-surface);
    box-shadow: 10px 0 30px rgba(0,0,0,0.05);
  }

  .rail-container {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 100%;
    width: 100%;
    position: relative;
    z-index: 2;
  }

  /* === SECTORS === */
  .rail-sector {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 24px 0;
    gap: 16px;
  }

  /* Typography */
  .marker-vertical {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    font-family: var(--font-code);
    font-size: 9px;
    color: var(--paper-line);
    letter-spacing: 2px;
    font-weight: 700;
    user-select: none;
    white-space: nowrap;
  }

  /* Decorative Screws */
  .screw-head {
    width: 8px; height: 8px;
    border: 1px solid var(--paper-line);
    border-radius: 50%;
    position: relative;
  }
  .screw-head::after {
    content: ''; position: absolute; top: 50%; left: 10%; right: 10%; height: 1px;
    background: var(--paper-line); transform: translateY(-50%) rotate(45deg);
  }

  /* === MIDDLE: CONTROLS === */
  .rail-sector.middle {
    position: relative;
    flex: 1;
    justify-content: center;
  }

  /* 1. Compact View (LED) */
  .status-compact {
    position: absolute;
    transition: opacity 0.2s;
    pointer-events: none;
  }
  
  .status-dot {
    width: 6px; height: 6px;
    background: var(--paper-line);
    border-radius: 50%;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
  }
  .status-dot.active {
    background: var(--arctic-cyan);
    box-shadow: 0 0 8px var(--arctic-cyan);
  }

  /* 2. Expanded View (Switch) */
  .control-mechanism {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    transition: opacity 0.4s 0.1s; /* Delay fade in */
    width: 100%;
  }

  .label-tiny {
    font-family: var(--font-code);
    font-size: 8px;
    color: var(--paper-ink);
    opacity: 0.5;
    letter-spacing: 1px;
  }

  .switch-track {
    width: 32px; height: 64px;
    background: var(--paper-bg);
    border: 1px solid var(--paper-line);
    border-radius: 4px;
    position: relative;
    cursor: pointer;
    padding: 0;
    box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
    transition: border-color 0.2s;
  }
  .switch-track:hover { border-color: var(--paper-ink); }
  .switch-track:focus { outline: 1px solid var(--arctic-cyan); }

  .switch-thumb {
    width: 24px; height: 24px;
    background: var(--paper-surface);
    border: 1px solid var(--paper-ink);
    border-radius: 2px;
    position: absolute;
    left: 3px;
    /* Spring physics for the snap */
    transition: top 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    display: flex; align-items: center; justify-content: center;
    z-index: 2;
  }

  .thumb-grip {
    width: 12px; height: 2px;
    border-top: 1px solid var(--paper-line);
    border-bottom: 1px solid var(--paper-line);
  }

  /* Toggle States */
  .switch-thumb.up { top: 4px; }
  .switch-thumb.down { 
    top: 34px; 
    background: var(--paper-ink);
    border-color: var(--paper-ink);
  }
  .switch-thumb.down .thumb-grip { border-color: var(--paper-bg); }

  .track-marks {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    display: flex; flex-direction: column; justify-content: space-between;
    padding: 8px 0;
    pointer-events: none;
    z-index: 1;
  }
  .track-marks span {
    font-family: var(--font-code); font-size: 8px; color: var(--paper-line);
    text-align: center; width: 100%;
  }

  .mode-readout {
    font-family: var(--font-code);
    font-size: 10px;
    font-weight: 700;
    color: var(--paper-ink);
    text-transform: uppercase;
  }

  /* === TEXTURE === */
  .rail-texture {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    opacity: 0.05;
    background-image: repeating-linear-gradient(
      -45deg,
      transparent,
      transparent 2px,
      #000 2px,
      #000 3px
    );
    pointer-events: none;
    z-index: 1;
  }
</style>